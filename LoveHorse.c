#include <stdint.h>

typedef int8_t   i8;
typedef uint8_t  u8;
typedef int16_t  i16;
typedef uint16_t u16;
typedef int32_t  i32;
typedef uint32_t u32;
typedef int64_t  i64;
typedef uint64_t u64;
typedef float    r32;
typedef double   r64;
typedef i32      b32;

extern int StringLength(char *str);
extern void CopyMemory(void *dest, void *src, int len);
extern u32 GetTicks(void);

#define MODE_FB0 0x00020000
#define VRAM_ENABLE 0x80
#define VRAM_A_LCD 0
#define VRAM_A 0x06800000


u16 ColorTable[16] = 
{
    0x0000,
    0x1111,
    0x2222,
    0x3333,
    0x4444,
    0x5555,
    0x6666,
    0x7777,
    0x8888,
    0x9999,
    0xAAAA,
    0xBBBB,
    0xCCCC,
    0xDDDD,
    0xEEEE,
    0xFFFF
};

int _start(void)
{
    u32 IoSpace = 0x04000000;
    u32 Counter = 0;
    u32 LastCounter = 0;
    u16 Color = 0;

    // POWERCNT
    *(u32 *)(IoSpace + 0x304) = 0x00000003; // Both screens on

    //Use VRAM_A as framebuffer
    *(u32 *)(IoSpace) = MODE_FB0; // DISPCNT

    // VRAM bank A enabled in LCD mode
    *(u32 *)(IoSpace + 0x240) = (VRAM_ENABLE | VRAM_A_LCD); // VRAMCNT_A

    // Full brightness
    *(u32 *)(IoSpace + 0x06C) = 0x00000000; // May not need this because not fifa

    Counter = GetTicks();
    while (1)
    {
        u32 PixelCount = 256 * 192;
        u16 *VramA = (u16 *)VRAM_A;

        Counter = GetTicks();

        if (Counter - LastCounter > 670280)
        {
            while (--PixelCount)
            {
                *(u16 *)(VramA++) = ColorTable[Color % 16];
            }
            LastCounter = Counter;
        }

        ++Color;
    }

	return IoSpace;
}

